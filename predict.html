<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <link rel="stylesheet" href="/src/style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CardiAct - Predict</title>
  </head>
  <body>

    <nav>
      <div id="tcoupled">
        <img src="/heart.png" />  
        <h1>CardiAct</h1>
      </div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="/predict.html">Predict</a></li>
        <li><a href="/about.html">About Us</a></li>
      </ul>
    </nav>

    <div id="app">

        <div id="inputs">

            <div class="formvalues">
                <label for="age">Age (years):</label>
                <input type="number" name="age" id="age" />
            </div>

            <div class="formvalues">
                <label for="sex">Sex:</label>
                <select name="sex" id="sex">
                    <option value="M">M</option>
                    <option value="M">F</option>
                </select>
            </div>

            <div class="formvalues">
                <label for="chestpaintype">Chest Pain Type:</label>
                <select name="chestpaintype" id="chestpaintype">
                    <option value="TA">TA: Typical Angina</option>
                    <option value="ATA">ATA: Atypical Angina</option>
                    <option value="NAP">NAP: Non-Anginal Pain</option>
                    <option value="ASY">ASY: Asymptomatic</option>
                </select>
            </div>

            <div class="formvalues">
                <label for="restingbp">Resting BP (mmHg):</label>
                <input type="number" name="restingbp" id="restingbp" />
            </div>

            <div class="formvalues">
                <label for="serumchol">Serum Cholesterol (mm/dl):</label>
                <input type="number" name="serumchol" id="serumchol" />
            </div>

            <div class="formvalues">
                <label for="fastingbs">Fasting BS:</label>
                <select name="fastingbs" id="fastingbs">
                    <option value="1">>120 mg/dl</option>
                    <option value="0"><=120mg/dl</option>
                </select>
            </div>

            <div class="formvalues">
                <label for="restingecg">Resting ECG:</label>
                <select name="restingecg" id="restingecg">
                    <option value="Normal">Normal</option>
                    <option value="ST">ST: having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV)</option>
                    <option value="LVH">LVH: showing probable or definite left ventricular hypertrophy by Estes' criteria</option>
                </select>
            </div>

            <div class="formvalues">
                <label for="maxhr">Max Heart Rate:</label>
                <input type="number" name="maxhr" id="maxhr" />
            </div>

            <div class="formvalues">
                <label for="exerciseangina">Exercise-induced Angina:</label>
                <select name="exerciseangina" id="exerciseangina">
                    <option value="Y">Yes</option>
                    <option value="N">No</option>
                </select>
            </div>
            
            <div class="formvalues">
                <label for="oldpeak">Oldpeak:</label>
                <input type="number" name="oldpeak" id="oldpeak" />
            </div>

            <div class="formvalues">
                <label for="stslope">ST Slope:</label>
                <select name="stslope" id="stslope">
                    <option value="Up">upsloping</option>
                    <option value="Flat">flat</option>
                    <option value="Down">downsloping</option>
                </select>
            </div>

            <button id="submit">Predict</button>
            <p id="prediction-value"></p>
        </div>


        <button id="chatbot">
            Need Help?
        </button>
        
        <div id="chat">
            <button id="closechat">X</button>
            <div id="messages">
                <div class="msg">Bot: Welcome! I'm here to help. Ask any questions regarding the form fields or relating to heart health!</div>
            </div>

            <textarea id="chatinput" placeholder="Ask away!"></textarea>
            <button id="chatsend">Send</button>
        </div>

    </div>
  </body>

  <script src="/src/main.js"></script>

  <script>
    // Collect inputs and call the backend prediction endpoint
    document.getElementById('submit').addEventListener('click', async function () {
        const outEl = document.getElementById('prediction-value');
        outEl.textContent = '...loading';

        const payload = {
            Age: document.getElementById('age').value,
            Sex: document.getElementById('sex').value,
            ChestPainType: document.getElementById('chestpaintype').value,
            RestingBP: document.getElementById('restingbp').value,
            Cholesterol: document.getElementById('serumchol').value,
            FastingBS: document.getElementById('fastingbs').value,
            RestingECG: document.getElementById('restingecg').value,
            MaxHR: document.getElementById('maxhr').value,
            ExerciseAngina: document.getElementById('exerciseangina').value,
            Oldpeak: document.getElementById('oldpeak').value,
            ST_Slope: document.getElementById('stslope').value
        };

        try {
            const res = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                let errText = 'Prediction failed';
                try {
                    const err = await res.json();
                    errText = err.error || JSON.stringify(err);
                } catch (e) {
                    errText = await res.text();
                }
                console.error('Prediction API error:', res.status, errText);
                outEl.textContent = 'Error';
                alert('Prediction failed: ' + errText);
                return;
            }

            const data = await res.json();
            console.log('Prediction result:', data);
            if (data.prediction == 0){
                outEl.textContent = "Little risk of heart disease."
            }else{
                outEl.textContent = "High risk of heart disease."
            }
        } catch (e) {
            console.error('Fetch error:', e);
            outEl.textContent = 'Service unreachable';
            alert('Could not reach prediction service. Make sure the Flask app is running and you opened the page via http://localhost:5000/predict-output.html');
        }
    });
    </script>
  
</html>
